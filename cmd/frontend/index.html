<!DOCTYPE html>

<head>
    <title>Palading winrates over time</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0"></script>
    <style>
        canvas {
            -moz-user-select: none;
            -webkit-user-select: none;
            -ms-user-select: none;
            max-width: 100%;
        }

        * {
            margin: 0;
            padding: 0;
            border: 0;
            outline: 0;
            /* border: 1px solid red; */
        }

        .active {
            background: linear-gradient(90deg, #8fbcbb 0%, #88c0d0 35%, #5e81ac 100%);
        }

        li {
            list-style-type: none;
        }


        body {
            height: 100vh;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: 3fr 1fr;
            grid-column-gap: 0.5rem;
            grid-row-gap: 1rem;
        }

        #canvas-container {
            grid-area: 1 / 1 / 2 / 5;
            margin: 1rem 1rem 0 1rem;
        }

        #classes-container {
            grid-area: 2 / 1 / 3 / 2;
            margin: 0 0 0 1rem;
        }

        #champions-container {
            grid-area: 2 / 2 / 3 / 3;
            max-height: 14rem;
        }

        #stat-container {
            grid-area: 2 / 3 / 3 / 4;
        }

        ul {
            max-height: 13rem;
            overflow: auto;
        }
    </style>
</head>

<body>
    <div id="canvas-container">
        <canvas id="canvas" class="chartjs-render-monitor"></canvas>
    </div>
    <div id="classes-container" class="list-container">
        <h4>Classes</h4>
        <ul id="classes" onclick="onClassesClick(event)">
        </ul>
    </div>
    <div id="champions-container" class="list-container">
        <h4>Champions</h4>
        <ul id="champions" onclick="onChampionsClick(event)">
        </ul>
    </div>
    <div id="stat-container" class="list-container">
        <h4>Stat</h4>
        <ul id="stat" onclick="onStatsClick(event)">
            <li id="stat-max" class="active">max</li>
            <li id="stat-avg" class="active">avg</li>
        </ul>
    </div>

    <script>
        toggleActiveClass = (classList) => classList.contains("active") ? classList.remove("active") : classList.add("active")
        toggleChart = champion => {
            const pointers = championToIndex[champion.textContent]
            if (champion.hidden || !champion.classList.contains("active")) {
                wrChart.data.datasets[pointers.max].hidden = true
                wrChart.data.datasets[pointers.avg].hidden = true
            } else if (champion.classList.contains("active")) {
                wrChart.data.datasets[pointers.max].hidden = !document.getElementById("stat-max").classList.contains("active")
                wrChart.data.datasets[pointers.avg].hidden = !document.getElementById("stat-avg").classList.contains("active")
            }
        }
        toggleChampionVisibility = classO => {
            const isActive = classO.classList.contains("active")
            const champions = classToChampion[classO.textContent]
            for (champion of champions) {
                champion.hidden = !isActive
            }
        }

        function onClassesClick(e) {
            if (e.target.tagName !== "LI" || !wrChart)
                return

            toggleActiveClass(e.target.classList)
            toggleChampionVisibility(e.target)
            for (champion of document.getElementById("champions").children) {
                toggleChart(champion)
            }

            wrChart.update()
        }

        function onChampionsClick(e) {
            if (e.target.tagName !== "LI" || !wrChart)
                return

            toggleActiveClass(e.target.classList)
            toggleChart(e.target)

            wrChart.update()
        }

        function onStatsClick(e) {
            if (e.target.tagName !== "LI" || !wrChart)
                return

            toggleActiveClass(e.target.classList)
            for (champion of document.getElementById("champions").children) {
                toggleChart(champion)
            }

            wrChart.update()
        }
        
        // statRequest = fetch('https://paladinswr.dyslav.it')
        statRequest = fetch('./stats')

        let classToChampion = {}
        let championToIndex = {}
        let statToIndex = { max: [], avg: [] }

        window.onload = function () {
            statRequest
                .then(response => {
                    return response.json()
                })
                .then(championData => {
                    console.log(championData)
                    classToChampion = Object.keys(championData).map(className => ({ [className]: [] })).reduce((acc, sing) => Object.assign(acc, sing))
                    let config = {
                        type: 'line',
                        data: {
                            datasets: []
                        },
                        options: {
                            scales: {
                                xAxes: [{
                                    type: 'time',
                                    time: {
                                        displayFormats: {
                                            "datetime": "MMM D, YYYY, HH:mm",
                                            "day": "MMM D",
                                            "hour": "D/HH:mm",
                                            "millisecond": "h:mm:ss.SSS a",
                                            "minute": "h:mm a",
                                            "month": "MMM YYYY",
                                            "quarter": "[Q]Q - YYYY",
                                            "second": "h:mm:ss a",
                                            "week": "ll",
                                            "year": "YYYY",
                                        },
                                    },
                                    display: true,
                                    gridLines: { display: false }
                                }]
                            },
                            responsive: true,
                            maintainAspectRatio: false,
                            legend: {
                                display: false,
                            },
                            hover: {
                                mode: 'index'
                            },
                        },
                    }

                    for (className in championData) {
                        { // create class list entry
                            let championClassListItem = document.createElement("li")
                            championClassListItem.classList.add("active")
                            championClassListItem.appendChild(document.createTextNode(className))

                            document.getElementById("classes").appendChild(championClassListItem)
                        }

                        for (championName in championData[className]) {
                            let championsListItem = document.createElement("li")
                            { // create champion list entry
                                championsListItem.classList.add("active")
                                championsListItem.appendChild(document.createTextNode(championName))

                                document.getElementById("champions").appendChild(championsListItem)
                            }


                            championToIndex[championName] = { max: config.data.datasets.length, avg: config.data.datasets.length + 1 }
                            statToIndex.max = statToIndex.max.concat([config.data.datasets.length])
                            statToIndex.avg = statToIndex.avg.concat([config.data.datasets.length + 1])
                            classToChampion[className] = classToChampion[className].concat([championsListItem])


                            { // chart.js datasets
                                config.data.datasets.push({
                                    label: `${championName} - max`,
                                    data: Object.keys(championData[className][championName]).map(datapointTS => (
                                        {
                                            x: Date.parse(datapointTS),
                                            y: championData[className][championName][datapointTS].max,
                                        })),
                                    fill: false,
                                    pointHoverRadius: 10,
                                })
                                config.data.datasets.push({
                                    label: `${championName} - avg`,
                                    data: Object.keys(championData[className][championName]).map(datapointTS => (
                                        {
                                            x: Date.parse(datapointTS),
                                            y: championData[className][championName][datapointTS].avg,
                                        })),
                                    fill: false,
                                    pointHoverRadius: 10,
                                })
                            }
                        }
                    }

                    const ctx = document.getElementById('canvas').getContext('2d');
                    window.wrChart = new Chart(ctx, config);
                })
                .catch(err => {
                    console.error(err)
                })
        };
    </script>



</body>